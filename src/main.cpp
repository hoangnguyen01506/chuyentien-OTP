#include "../include/ui.h"
#include "../include/user.h"
#include "../include/database.h"
#include "../otp/otp.h"
#include <windows.h>
#include <bits/stdc++.h>

using namespace std;

void enableVirtualTerminal() {
    HANDLE hOut = GetStdHandle(STD_OUTPUT_HANDLE);
    DWORD dwMode = 0;
    GetConsoleMode(hOut, &dwMode);
    dwMode |= ENABLE_VIRTUAL_TERMINAL_PROCESSING;
    SetConsoleMode(hOut, dwMode);
}

bool verifyOTPAndRegister(User& user, Database& db, const string& email, const string& username) {
    string otp = createOTP(email);
    if (otp.empty()) {
        cerr << "Unable to generate or send OTP." << endl;
        return false;
    }

    while (true) {
        string user_input;
        cout << "Enter the OTP code you received: ";
        getline(cin, user_input);
        if (user_input == otp) {
            cout << "Verification successful!" << endl;
            user.registerToDB(db);
            if (db.createWalletForUser(username)) {
                cout << "Wallet created.\n";
            } else {
                cerr << "Failed to create wallet.\n";
            }
            return true;
        } else {
            system("cls");
            cout << "Verification failed. Incorrect OTP. Please try again." << endl;
        }
    }
}

int main() {
    enableVirtualTerminal();
    Database db;
    string currentUsername;

    if (!db.connect("data/users.db")) {
        showMessage("Failed to create or open database.");
        return 1;
    }
    if (!db.createViTienTable() || !db.createTransactionHistoryTable()) {
        showMessage("Failed to create required tables.");
        return 1;
    }

    while (true) {
        showMenu();
        char choice = getMenuChoice();
        system("cls");

        if (choice == '1') {
            showLoginScreen();
            string username = getInput("Enter your username: ");
            string password = getInput("Enter your password: ");

            User tempUser("", "", false);
            if (tempUser.loginFromDB(db, username, password)) {
                currentUsername = username;
                showMessage(">> LOGIN SUCCESSFUL <<");
                db.showBalance(currentUsername);
                system("pause"); system("cls");
            } else {
                showMessage(">> LOGIN FAILED. Returning to main menu.");
                system("pause"); system("cls");
                continue;
            }
        } else if (choice == '2') {
            while (true) {
                showRegisterScreen();
                string username = getInput("Enter a username: ");
                string password = getInput("Enter a password: ");
                string email = getInput("Enter your email: ");
                string name = getInput("Enter your full name: ");

                User newUser(username, password, false, email, name);
                if (newUser.validateNewUser(db)) {
                    if (verifyOTPAndRegister(newUser, db, email, username)) {
                        showMessage(">>> ACCOUNT CREATED SUCCESSFULLY <<<");
                        cout << "Your account number is: " << newUser.getAccountNumber() << endl;
                        system("pause"); system("cls");
                        break;
                    }
                } else {
                    showMessage("Invalid input or username already exists.");
                    system("pause"); system("cls");
                }
            }
        } else if (choice == '3') {  // REGISTER FOR MANAGER
            while (true) {
                while (true) {
                        string adminPassword = getInput("Enter admin password: ");
                        if (adminPassword == "admin123") {
                            system("cls");
                            break;
                        } else {
                            showMessage("WRONG PASSWORD\n");
                            system("pause");
                            system("cls");
                        }
                }

                //
                showManagerMenu();    //Giao diá»‡n quáº£n lÃ­
                char choice = getMenuChoice();
                system("cls");

                if (choice == '1') {        //táº¡o tk cho user

                    showRegisterScreenForMnger();
                                  
                    string username = getInput("Please enter your username: ");
                    string email;
                    while (true) {      //HÃ m check email há»£p lá»‡
                        string tempEmail = getInput("Please enter your email: ");
                        if (User::isValidGmail(tempEmail)) {
                            email = tempEmail;
                            break;
                        }
                    }  
                    string name = getInput("Please enter your name: ");
                    
                    string autoPassword = User::AutoGenerated();

                    User newUser(username, autoPassword, true, email, name);
                    if (newUser.validateNewUser(db)) {

                        string otp = createOTP(email);       //táº¡o OTP
                                if (otp.empty()) {
                                    cerr << "KhÃ´ng thá»ƒ táº¡o hoáº·c gá»­i OTP." << endl;      //flag kiá»ƒm tra mÃ£ OTP luÃ´n Ä‘Æ°á»£c gá»­i
                                }
                            while (true) {    
                                string user_input;
                                cout << "Nháº­p mÃ£ OTP báº¡n nháº­n Ä‘Æ°á»£c: ";
                                getline(cin, user_input);

                                if (user_input == otp) {
                                    cout << "XÃ¡c thá»±c thÃ nh cÃ´ng!" << endl;
                                    newUser.registerToDB(db);
                                    if(db.createWalletForUser(username)){
                                        cout << "Wallet created successfully " << endl;
                                    }
                                    else{
                                        cout << "Failed to created" << endl;
                                    }
                                    break;
                                }    else {
                                    system("cls");
                                    cout << "XÃ¡c thá»±c tháº¥t báº¡i. MÃ£ OTP khÃ´ng Ä‘Ãºng. Vui lÃ²ng nháº­p láº¡i." << endl;
                                }
                            }

                        showMessage("User created! Auto-generated password: " + autoPassword);
                        system("pause");
                        system("cls");
                        break;
                    } else {
                        showMessage("Invalid input or username exists!\n");
                        system("pause");
                        system("cls");
                    }
                } else if (choice == '2') {     //  change in4 user

                    //
                    string tempUsername;
                    string userEmail;
                    string otp;
                    while (true) {
                        tempUsername = getInput("Nháº­p username cá»§a ngÆ°á»i dÃ¹ng hiá»‡n táº¡i: ");
                        
                        // Láº¥y email tá»« cÆ¡ sá»Ÿ dá»¯ liá»‡u
                        User tempUser ("", "", false);
                        userEmail = tempUser.getUserEmail(db, tempUsername);
                        if (userEmail.empty()) {
                            showMessage("No email found for this user. Cannot send OTP.\n");
                            system("pause");
                            system("cls");
                            continue;
                        }
                        break;
                    }
                        otp = createOTP(userEmail);       //táº¡o OTP
                        if (otp.empty()) {
                            cerr << "KhÃ´ng thá»ƒ táº¡o hoáº·c gá»­i OTP." << endl;      //flag kiá»ƒm tra mÃ£ OTP luÃ´n Ä‘Æ°á»£c gá»­i
                        }
                    
                    while (true) {
                        string user_input;
                        cout << "Nháº­p mÃ£ OTP báº¡n nháº­n Ä‘Æ°á»£c: ";
                        getline(cin, user_input);

                        if (user_input == otp) {
                            cout << "XÃ¡c thá»±c thÃ nh cÃ´ng!" << endl;
                            break;
                        } else {
                            system("cls");
                            cout << "XÃ¡c thá»±c tháº¥t báº¡i. MÃ£ OTP khÃ´ng Ä‘Ãºng. Vui lÃ²ng nháº­p láº¡i." << endl;
                        }
                    } 
                    
                            
                    //

                    // Kiá»ƒm tra username tá»“n táº¡i
                    if (!db.userExists(tempUsername)) {
                        showMessage("Username khÃ´ng tá»“n táº¡i!");
                        system("pause");
                        system("cls");
                        continue;
                    }
                    while (true) {
                        system("cls");
                        showChangeInfoMenu();
                            char changechoice = getMenuChoice();
                            system("cls");
                            if (changechoice == '1') {      //change pass

                                // YÃªu cáº§u ng dÃ¹ng Ä‘Æ°a cho quáº£n lÃ­ name cá»§a mÃ¬nh, náº¿u name cÃ³ email tÆ°Æ¡ng á»©ng thÃ¬ gá»­i mÃ£ otp vá» gmail
                                // XÃ¡c nháº­n gmail thÃ nh cÃ´ng sáº½ cho user thay Ä‘á»•i mk vÃ o láº§n Ä‘Äƒng nháº­p tiáº¿p theo

                                if (db.updateIsAuto(tempUsername, 1)) {
                                    showMessage(">> Please re-login to change password <<");
                                    system("pause");
                                    break;
                                } else {
                                    showMessage("Failed to update IS_MANANGER");
                                    system("pause");
                                }
                             
                            }

                            else if (changechoice == '2') {     //change name    
                                
                                string newName = getInput("Please enter your new name: ");
                                User user(tempUsername, "", false);
                                //cout << "Debug: tempUsername = " << tempUsername << endl; // Gá»¡ lá»—i
                                if (user.changeName(db, newName)) {
                                    showMessage(">> NAME CHANGED <<");
                                    system("pause");
                                    system("cls");
                                    break;
                                } else {
                                    showMessage("Failed to change name.\n");
                                    system("pause");
                                    system("cls");
                                }
                            }
                        break;
                    }
                    //
                }
                break;
            }
        }

        while (!currentUsername.empty()) {
            User temp("", "", false);
            string userEmail = temp.getUserEmail(db, currentUsername);
            string accNum = db.getAccountNumber(currentUsername);

            cout << "\033[1;36mâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m\n";
            cout << "\033[1;36m   ðŸ§¾ ACCOUNT INFORMATION\033[0m\n";
            cout << "   \033[1;33mðŸ‘¤ Fullname:    \033[0;97m" << currentUsername << "\033[0m\n";
            cout << "   \033[1;33mðŸ“§ Email:       \033[0;97m" << userEmail << "\033[0m\n";
            cout << "   \033[1;33mðŸ’³ Account No.: \033[0;97m" << accNum << "\033[0m\n";
            cout << "\033[1;36mâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m\n\n";

            showTransactionMenu();
            char transactionChoice = getMenuChoice();
            system("cls");

            if (transactionChoice == '1') {
                showChanginPassScreen();
                while (true) {
                    string currentPassword = getInput("Enter current password: ");
                    User tempUser("", "", false);
                    if (tempUser.loginFromDB(db, currentUsername, currentPassword)) {
                        string email = tempUser.getUserEmail(db, currentUsername);
                        string otp = createOTP(email);
                        string input;
                        cout << "Enter OTP: "; getline(cin, input);
                        if (input != otp) {
                            showMessage("Incorrect OTP."); continue;
                        }
                        string newpass = getInput("Enter new password: ");
                        User user(currentUsername, newpass, false);
                        if (!user.changePassword(db, newpass)) {
                            showMessage("Failed to change password.");                          
                        } 
                            system("cls");
                            showMessage(">> PASSWORD CHANGED SUCCESSFULLY <<");
                            system("pause");
                            break;
                } else {
                    showMessage("Wrong password.");
                }
                    system("pause"); system("cls");
                }
            } else if (transactionChoice == '2') {
                showMessage(">> TRANSFER MONEY <<");
                string receiverAcc = getInput("Enter recipient's account number: ");
                string receiver = db.getUsernameByAccount(receiverAcc);
                if (receiver.empty()) {
                    showMessage(">> Invalid account number <<");
                    system("pause"); system("cls"); continue;
                }
                string senderEmail = temp.getUserEmail(db, currentUsername);
                string otp = createOTP(senderEmail);
                string inputOtp;
                cout << "Enter OTP to confirm transfer: "; getline(cin, inputOtp);
                if (inputOtp != otp) {
                    showMessage("Incorrect OTP. Transfer cancelled.");
                    system("pause"); system("cls"); continue;
                }
                double amount = stod(getInput("Enter amount to transfer: "));
                if (db.transferMoney(currentUsername, receiver, amount)) {
                    cout << "\033[1;32m";
                    cout << "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n";
                    cout << "â•‘           ðŸ’¸ TRANSFER SUCCESSFUL!         â•‘\n";
                    cout << "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n";
                    cout << "â•‘ ðŸ” From   : " << setw(30) << left << currentUsername << "â•‘\n";
                    cout << "â•‘ ðŸŽ¯ To     : " << setw(30) << left << receiver << "â•‘\n";
                    cout << "â•‘ ðŸ’µ Amount : " << setw(22) << left << (to_string((int)amount) + " VND") << "â•‘\n";
                    cout << "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
                    cout << "\033[0m";
                } else {
                    showMessage(">> TRANSFER FAILED <<");
                }
                system("pause"); system("cls");
            } else if (transactionChoice == '3') {
                double balance = db.getBalance(currentUsername);
                string formatted = formatCurrency(balance);
                printHeader("ACCOUNT BALANCE");
                cout << "\033[1;32m";
                cout << "\n   Your current balance is:\n\n";
                cout << "   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n";
                cout << "   â•‘     " << setw(20) << right << formatted << "     â•‘\n";
                cout << "   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
                cout << "\033[0m";
                system("pause"); system("cls");
            } else if (transactionChoice == '4') {
                auto history = db.getTransactionHistory(currentUsername);
                cout << "=== Lá»‹ch sá»­ giao dá»‹ch cá»§a " << currentUsername << " ===\n";
                cout << "Thá»i gian          | Loáº¡i giao dá»‹ch | Sá»‘ tiá»n   | Äá»‘i tÃ¡c\n";
                cout << "----------------------------------------------------------\n";
                for (const auto& [datetime, type, amount, partner] : history) {
                    cout << datetime << " | " << type << " | " << amount << " VND | " << partner << '\n';
                }
                system("pause"); system("cls");
            } else if (transactionChoice == '5') {
                currentUsername = "";
                showMessage(">> LOGGED OUT <<");
                system("pause"); system("cls");
                break;
            }
        }
    }

    return 0;
}